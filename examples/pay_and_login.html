<html>

<head>
    <meta charset="utf-8" />

    <title>Big Nerd Ranch D3 Blog Post</title>
    <header name="Access-Control-Allow-Origin" value="*" />
</head>

<body>
    <p>plain text: <span id="plaintext">hello world </span></p>

    <p>cipher text:
        <pre style="word-wrap: break-word" id="ciphertext"></pre>
    </p>
    <p>decrypt response text:
        <pre style="word-wrap: break-word" id="decrypttext"></pre>
    </p>

    <p>error: <span id="error" style="color: red"></span></p>
    <script src="../dist/jose.js"></script>

    <script>
        var server_pub_rsa_key_verify = { "e": "AQAB", "kty": "RSA", "n": "nxuARX905_3pDATluPJB5NMalvPgqc9FImgDQXZ3scpWiumVYC2disk2qSlnH8ZgBnTXvkQUyNKxfmMum9qkgHJXwKtxVoKdIVrQPy3hiC9U0tFGSvgGNeFp5qaEsm5SK8R7Y2kWWz4VEl9n0TTdmO-0D1P4co-hlk0eo4JLU95aJxpwuNafDoZDm4MZM04D4kh3ZxC_mXklT8WRQ8E-bOnkOYCfqQiniLXIHQvV7eSVgHYokhcnhK9GYaOe73gNwEdXuBQAabZsvBAasaWaPMrkfGOef9RFPt6wHDpgmpJBgSJRuAI19f7hAlJI5DeUT0TwzgU6xVfOC08sQlYVjQ" }
        server_pub_rsa_key_verify["kid"] = "server_kid"

        var js_pub_key = { "kid": "hello", "use": "enc", "alg": "RSA-OAEP", "enc": "A256CBC-HS512", "e": "AQAB", "kty": "RSA", "n": "yfTdA3PJzyo2LT899lspEA8QESzDDMO-rRu7VtIKCSgBliCCI4etuVHU--2h3JXFHaNttfFTm2uA1ps1G86q90tvTol7MBqSZgD51dlBP_V5vDtdkmi_sS38Szfz_Qu6CS2-JxDmLdrBPJAXJjOW13Sz6e-cjT3TCsmV3n4zqyYbLSHOBdLpLAcH6JWtqsJE8bED68C5EZzfBtWoOXWtsNJgsGIQ2hugdh-VAm4lCPaSIOdQKGczfvSRFcsTMCKox9norysq3rfKqh0b_UBfcBDhFtFnVrCFGVtsbKV9OIf404J_QOpH8pjeyAVcocBN4TzJilrOfiDlcSvaztkaEQ" }
        var js_priv_key_decrypt = { "kid": "hello", "d": "iQ5AH2OpBYqkEbjlmBbtmxRd1woFpNgCwwAa9yS74tLfoL6XEv21DBtY60-tlUGe8CpE_kC0eLlQSlQyipiKtiDffPEYROEDkW4AHvy9p2Y0I2Y2bnHgBaIrofBrCMO4kRoV_fUeAOiAU1WGIErKh5WPs6cFG2Vln-CGcOQ8tFyG-PCpwrhNlQJP5XnkbL56H9e9R-AnuKVSDm3TFM_gtKGfMpEM1g3Y7rK9LoV-l24FyEBFGth5wcr2Mb4ZxOEYslKAxhztelaU0WFnzguByMkgZAmfJDGy64XsZzdEbYqM5aPhCMEyFIQ3BVcTtr_llbo94gm6osB5klewTpD3AQ", "dp": "O6BCOMXuTCuigTJPl2-jW3udnu4kbJsoItxP2Izg914jJbEjSz6BGvezg1MXZ3eiAemhHeh5vMi0YGtw75lKIWdsHPARi2lhhjHKVd7ZPwTViK61l8L86azOL2T7O8Y244kNCXisgUmLpRyZi20QfUTIV8cI0j7hQiZEXU9M35E", "dq": "af5cgcHR9IMBZiChaHKcA4zMgzTxiLs-XcDZiLADGAdmh-sI1WJEZug38z6QrzCm84neo7wA4PjWgJV0PxP0FtfR67krlIa4YhY6J9ZzOXm0qYURwGpMhjxLTqvWlgBxz-Qj7rT0yedyxEoX0FwwTr8UDoyt6UaJhb79zaqMxkE", "e": "AQAB", "kty": "RSA", "n": "yfTdA3PJzyo2LT899lspEA8QESzDDMO-rRu7VtIKCSgBliCCI4etuVHU--2h3JXFHaNttfFTm2uA1ps1G86q90tvTol7MBqSZgD51dlBP_V5vDtdkmi_sS38Szfz_Qu6CS2-JxDmLdrBPJAXJjOW13Sz6e-cjT3TCsmV3n4zqyYbLSHOBdLpLAcH6JWtqsJE8bED68C5EZzfBtWoOXWtsNJgsGIQ2hugdh-VAm4lCPaSIOdQKGczfvSRFcsTMCKox9norysq3rfKqh0b_UBfcBDhFtFnVrCFGVtsbKV9OIf404J_QOpH8pjeyAVcocBN4TzJilrOfiDlcSvaztkaEQ", "p": "7y3gXWO794Gf3jr9jTptKvLC5kSOsY3w_UfWdZdq5dGYtRNJzpOriS3S26hL4MWz_446WBWuKjgc-VJ4sul-vd6uHpa2QOpcMJApvKRSktHZChA0v8wtc1HCNGJRLV5mgKw-FrcrjycX08EteMlAT45Es56cZYfHm5Xt0T0MnIk", "q": "2CjWpAaHqoPWxrlBxu5BTsaUnc4S-QchZuqU0d9WSiMKIKRMu7UBSLAjZbMsh18Rr7UzByih2RM99MBfgJtlm0Z9kxyLjGnkqqfVKJms5YcnmfvBltDAmAAjxpK_Exxr9bkp5IoxUTmFWeWVyHXG27u0Zfj2K18K3jpG1xa0_0k", "qi": "bx8lw3-6-LqNzlMbp4VXsHAMUQ0LdNGwFtV-2-wemd4MMVLB7BawY73AWPaaaMOpyVBuqtfvxWnCspxm2HDUTrLsfJzswDOmGCJzzaFSSoyJhdX03dS_bhALrTdyX958Y58hSv6Pt1sBdZd55KjZ4aiNV3Jatr3pbtwvFgqc1N0" }
        var js_priv_key_sign = {
            "kid": "hello",
            "alg": "RS256",
            "key_ops": ["sign"],
            "d": "iQ5AH2OpBYqkEbjlmBbtmxRd1woFpNgCwwAa9yS74tLfoL6XEv21DBtY60-tlUGe8CpE_kC0eLlQSlQyipiKtiDffPEYROEDkW4AHvy9p2Y0I2Y2bnHgBaIrofBrCMO4kRoV_fUeAOiAU1WGIErKh5WPs6cFG2Vln-CGcOQ8tFyG-PCpwrhNlQJP5XnkbL56H9e9R-AnuKVSDm3TFM_gtKGfMpEM1g3Y7rK9LoV-l24FyEBFGth5wcr2Mb4ZxOEYslKAxhztelaU0WFnzguByMkgZAmfJDGy64XsZzdEbYqM5aPhCMEyFIQ3BVcTtr_llbo94gm6osB5klewTpD3AQ",
            "dp": "O6BCOMXuTCuigTJPl2-jW3udnu4kbJsoItxP2Izg914jJbEjSz6BGvezg1MXZ3eiAemhHeh5vMi0YGtw75lKIWdsHPARi2lhhjHKVd7ZPwTViK61l8L86azOL2T7O8Y244kNCXisgUmLpRyZi20QfUTIV8cI0j7hQiZEXU9M35E",
            "dq": "af5cgcHR9IMBZiChaHKcA4zMgzTxiLs-XcDZiLADGAdmh-sI1WJEZug38z6QrzCm84neo7wA4PjWgJV0PxP0FtfR67krlIa4YhY6J9ZzOXm0qYURwGpMhjxLTqvWlgBxz-Qj7rT0yedyxEoX0FwwTr8UDoyt6UaJhb79zaqMxkE",
            "e": "AQAB",
            "kty": "RSA",
            "n": "yfTdA3PJzyo2LT899lspEA8QESzDDMO-rRu7VtIKCSgBliCCI4etuVHU--2h3JXFHaNttfFTm2uA1ps1G86q90tvTol7MBqSZgD51dlBP_V5vDtdkmi_sS38Szfz_Qu6CS2-JxDmLdrBPJAXJjOW13Sz6e-cjT3TCsmV3n4zqyYbLSHOBdLpLAcH6JWtqsJE8bED68C5EZzfBtWoOXWtsNJgsGIQ2hugdh-VAm4lCPaSIOdQKGczfvSRFcsTMCKox9norysq3rfKqh0b_UBfcBDhFtFnVrCFGVtsbKV9OIf404J_QOpH8pjeyAVcocBN4TzJilrOfiDlcSvaztkaEQ",
            "p": "7y3gXWO794Gf3jr9jTptKvLC5kSOsY3w_UfWdZdq5dGYtRNJzpOriS3S26hL4MWz_446WBWuKjgc-VJ4sul-vd6uHpa2QOpcMJApvKRSktHZChA0v8wtc1HCNGJRLV5mgKw-FrcrjycX08EteMlAT45Es56cZYfHm5Xt0T0MnIk",
            "q": "2CjWpAaHqoPWxrlBxu5BTsaUnc4S-QchZuqU0d9WSiMKIKRMu7UBSLAjZbMsh18Rr7UzByih2RM99MBfgJtlm0Z9kxyLjGnkqqfVKJms5YcnmfvBltDAmAAjxpK_Exxr9bkp5IoxUTmFWeWVyHXG27u0Zfj2K18K3jpG1xa0_0k", "qi": "bx8lw3-6-LqNzlMbp4VXsHAMUQ0LdNGwFtV-2-wemd4MMVLB7BawY73AWPaaaMOpyVBuqtfvxWnCspxm2HDUTrLsfJzswDOmGCJzzaFSSoyJhdX03dS_bhALrTdyX958Y58hSv6Pt1sBdZd55KjZ4aiNV3Jatr3pbtwvFgqc1N0"
        }
        var cryptographer = new Jose.WebCryptographer();



        var private_rsa_key = Jose.Utils.importRsaPrivateKey(js_priv_key_decrypt, "RSA-OAEP");

        function to_b58(B, A) {
            var d = [],   //the array for storing the stream of base58 digits
                s = "",   //the result string variable that will be returned
                i,        //the iterator variable for the byte input
                j,        //the iterator variable for the base58 digit array (d)
                c,        //the carry amount variable that is used to overflow from the current base58 digit to the next base58 digit
                n;        //a temporary placeholder variable for the current base58 digit
            for (i in B) { //loop through each byte in the input stream
                j = 0,                           //reset the base58 digit iterator
                    c = B[i];                        //set the initial carry amount equal to the current byte amount
                s += c || s.length ^ i ? "" : 1; //prepend the result string with a "1" (0 in base58) if the byte stream is zero and non-zero bytes haven't been seen yet (to ensure correct decode length)
                while (j in d || c) {             //start looping through the digits until there are no more digits and no carry amount
                    n = d[j];                    //set the placeholder for the current base58 digit
                    n = n ? n * 256 + c : c;     //shift the current base58 one byte and add the carry amount (or just add the carry amount if this is a new digit)
                    c = n / 58 | 0;              //find the new carry amount (floored integer of current digit divided by 58)
                    d[j] = n % 58;               //reset the current base58 digit to the remainder (the carry amount will pass on the overflow)
                    j++                          //iterate to the next base58 digit
                }
            }
            while (j--)        //since the base58 digits are backwards, loop through them in reverse order
                s += A[d[j]]; //lookup the character associated with each base58 digit
            return s          //return the final base58 string
        }
        function base64ArrayBuffer(arrayBuffer) {
            var base64 = ''
            var encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

            var bytes = new Uint8Array(arrayBuffer)
            var byteLength = bytes.byteLength
            var byteRemainder = byteLength % 3
            var mainLength = byteLength - byteRemainder

            var a, b, c, d
            var chunk

            // Main loop deals with bytes in chunks of 3
            for (var i = 0; i < mainLength; i = i + 3) {
                // Combine the three bytes into a single integer
                chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2]

                // Use bitmasks to extract 6-bit segments from the triplet
                a = (chunk & 16515072) >> 18 // 16515072 = (2^6 - 1) << 18
                b = (chunk & 258048) >> 12 // 258048   = (2^6 - 1) << 12
                c = (chunk & 4032) >> 6 // 4032     = (2^6 - 1) << 6
                d = chunk & 63               // 63       = 2^6 - 1

                // Convert the raw binary segments to the appropriate ASCII encoding
                base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d]
            }

            // Deal with the remaining bytes and padding
            if (byteRemainder == 1) {
                chunk = bytes[mainLength]

                a = (chunk & 252) >> 2 // 252 = (2^6 - 1) << 2

                // Set the 4 least significant bits to zero
                b = (chunk & 3) << 4 // 3   = 2^2 - 1

                base64 += encodings[a] + encodings[b] + '=='
            } else if (byteRemainder == 2) {
                chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1]

                a = (chunk & 64512) >> 10 // 64512 = (2^6 - 1) << 10
                b = (chunk & 1008) >> 4 // 1008  = (2^6 - 1) << 4

                // Set the 2 least significant bits to zero
                c = (chunk & 15) << 2 // 15    = 2^4 - 1

                base64 += encodings[a] + encodings[b] + encodings[c] + '='
            }

            return base64
        }
        var arrayFromString = function (str) {
            var arr = str.split('').map(function (c) {
                return c.charCodeAt(0);
            });
            return new Uint8Array(arr);
        };

        const ugetrl = 'http://127.0.0.1:8080/price';
        var xmlgethttp = new XMLHttpRequest();
        xmlgethttp.onreadystatechange = function () {
            console.log("price result");
            server_info_response = JSON.parse(xmlgethttp.responseText);
            server_info = server_info_response["content"];
            signature_ts = server_info_response["ts_signature"];
            server_public_key_from_server = server_info["PublicKey"];
            server_contract_address = server_info["ContractAddress"];
            server_price = server_info["Price"];
            server_ts = server_info["ts"];
            console.log(server_public_key_from_server);
            console.log(server_contract_address);
            console.log(server_price);
            console.log(server_ts);

            message = JSON.parse(signature_ts)
            var cryptographer_verify = new Jose.WebCryptographer();
            var verifier_server = new JoseJWS.Verifier(cryptographer_verify, message);
            verifier_server.addRecipient(server_public_key_from_server, server_public_key_from_server["kid"], "RS256").then(function () {
                verifier_server.verify().then(function (result) {
                    result.filter(function (value) {
                        server_ts = parseInt(value.payload);
                        client_ts = Date.now() / 1000;
                        diff = Math.abs(client_ts - server_ts);
                        console.log("time stamp compare")
                        console.log(server_ts);
                        console.log(client_ts);
                        console.log(diff);
                        if (diff < 300) {
                            console.log("server is correct");
                            console.log(JSON.stringify(value));
                            Jose.crypto.subtle.digest({ name: "SHA-256" }, arrayFromString(js_pub_key["n"])).then(function (hashfromarray) {
                                console.log("hash of public key array converted from string");
                                console.log(js_pub_key["n"])
                                console.log(new Uint8Array(hashfromarray));
                                console.log("b58 encoding");
                                var Base58_character = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
                                var encoded_in_b58 = to_b58(new Uint8Array(hashfromarray), Base58_character);
                                console.log(encoded_in_b58);
                                Jose.crypto.subtle.digest({ name: "SHA-256" }, new Uint8Array(hashfromarray)).then(function (double_hashfromarray) {
                                    var Base58_character = "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
                                    var double_encoded_in_b58 = to_b58(new Uint8Array(double_hashfromarray), Base58_character);
                                    content_to_signer = JSON.stringify({ "kid": double_encoded_in_b58, "ts": Date.now() })
                                    var cryptographer_sign_client = new Jose.WebCryptographer();
                                    cryptographer_sign_client.setContentSignAlgorithm("RS256");

                                    var signer = new JoseJWS.Signer(cryptographer_sign_client);
                                    signer.addSigner(js_priv_key_sign).then(function () {
                                        signer
                                            .sign(content_to_signer, null, {})
                                            .then(function (message) {
                                                signature_in_json = JSON.stringify(message);
                                                var to_server_payload = { "key": js_pub_key, "signature": signature_in_json, "request": "ss_cert" };
                                                to_encrypt_in_string = JSON.stringify(to_server_payload)
                                                console.log("prepare to encrypt")
                                                console.log(server_public_key_from_server)
                                                var public_rsa_key = Jose.Utils.importRsaPublicKey(server_public_key_from_server, "RSA-OAEP");
                                                var encrypter = new JoseJWE.Encrypter(cryptographer, public_rsa_key);
                                                console.log(server_public_key_from_server)
                                                encrypter.encrypt(to_encrypt_in_string).then(function (result) {
                                                    plaintext.textContent = to_encrypt_in_string
                                                    ciphertext.textContent = result;
                                                    const url = 'http://127.0.0.1:8080/cert.info?' + "code=" + result;
                                                    var xmlhttp = new XMLHttpRequest();
                                                    xmlhttp.onreadystatechange = function () {
                                                        var decrypter = new JoseJWE.Decrypter(cryptographer, private_rsa_key);
                                                        decrypter.decrypt(xmlhttp.responseText)
                                                            .then(function (decrypted_plain_text) {
                                                                decrypttext.textContent = decrypted_plain_text
                                                                message = JSON.parse(decrypted_plain_text)
                                                                var cryptographer_verify_II = new Jose.WebCryptographer();
                                                                var verifier_server_II = new JoseJWS.Verifier(cryptographer_verify_II, message);
                                                                server_public_key_from_server["alg"] = "RS256";
                                                                verifier_server_II.addRecipient(server_public_key_from_server, server_public_key_from_server["kid"], "RS256").then(function () {

                                                                //var verifier = new JoseJWS.Verifier(cryptographer_verify, message);
                                                                //verifier_server_II.addRecipient(server_pub_rsa_key_verify, server_pub_rsa_key_verify["kid"], "RS256").then(function () {
                                                                //var verifier_server = new JoseJWS.Verifier(cryptographer_verify, message);
                                                                //verifier_server_II.addRecipient(server_public_key_from_server, server_public_key_from_server["kid"], "RS256").then(function () {
                                                                    console.log(server_public_key_from_server)
                                                                    console.log(server_pub_rsa_key_verify)
                                                                    verifier_server_II.verify().then(function (result) {
                                                                        result.filter(function (value) {
                                                                            verified_payload = JSON.parse(value.payload);
                                                                            ss_cert = verified_payload["ss_cert"];
                                                                            ts = verified_payload["ts"];
                                                                            console.log(Date.now()/1000 - ts);
                                                                            if (ts < Date.now()) {
                                                                                decrypttext.textContent = JSON.stringify(value)
                                                                            }

                                                                        }).length == 0;
                                                                    });
                                                                });
                                                            }).catch(function (err) {
                                                                error.textContent = err;
                                                            });

                                                    }
                                                    xmlhttp.open("GET", url, false);
                                                    xmlhttp.send();

                                                }).catch(function (err) {
                                                    error.textContent = err;
                                                });
                                            })
                                            .catch(function (err) {
                                                console.error(err);
                                            });
                                    });
                                });
                            });

                        }


                    }).length == 0;
                });
            });
            return;
        }
        xmlgethttp.open("GET", ugetrl, false);
        xmlgethttp.send();



    </script>
</body>

</html>